{% extends 'base.html' %}
{% load static %}
{% block title %}
  Custom Your Profile!
{% endblock title %}

{% block extrahead %}
  <link rel="stylesheet" type="text/css" href="{% static "css/user/avatar.css"%}">
{% endblock extrahead %}

{% block content%}
  <div class="avatar-page-container">
    <div class="header-message">
      <span>이제 마지막!</span>
      <p>{{ user.nickname }} 님을 표현하는 캐릭터를<br>설정하면 끝이에요!</p>
    </div>
    <div class="profile-img-container">
      <div class="profile-image-wrapper">
        <div class="profile-wrapper">
          <div class="backhair"></div>
          <div class="face">
            <img src="{% static 'character/face.png' %}" alt="face">
          </div>
          <div class="fronthair"></div>
          <div class="brows"></div>
          <div class="eyes"></div>
          <div class="nose"></div>
          <div class="mouth"></div>
          <div class="makeup"></div>
          <div class="clothes"></div>
          <div class="acc"></div>
        </div>
      </div>
      <div class="random-option"></div>
    </div>
    <div class="options-select">
      <div class="hair">머리</div>
      <div class="face">표정</div>
      <div class="fashion">패션</div>
    </div>
    <div class="options-container">
      <div class="hair-container">
        <div>
          <label for="avatar">앞머리</label>
          <div class="item-selection avatar-section" id="fronthair">
            <img src="{% static "character/fronthair/fronthair1.png" %}" alt="앞머리 1" data-id="1" class="selected">
            <img src="{% static "character/fronthair/fronthair2.png" %}" alt="앞머리 2" data-id="2">
            <img src="{% static "character/fronthair/fronthair3.png" %}" alt="앞머리 3" data-id="3">
            <img src="{% static "character/fronthair/fronthair4.png" %}" alt="앞머리 4" data-id="4">
          </div>
        </div>
        <div>
          <label for="avatar">뒷머리</label>
          <div class="item-selection avatar-section-optional" id="backhair">
            <img src="{% static "character/backhair/backhair1.png" %}" alt="뒷머리 1" data-id="1">
            <img src="{% static "character/backhair/backhair2.png" %}" alt="뒷머리 2" data-id="2">
            <img src="{% static "character/backhair/backhair3.png" %}" alt="뒷머리 3" data-id="3">
            <img src="{% static "character/backhair/backhair4.png" %}" alt="뒷머리 4" data-id="4">
            <img src="{% static "character/backhair/backhair5.png" %}" alt="뒷머리 5" data-id="5">
          </div>
        </div>
      </div>
      <div class="face-container">
        <div>
          <label for="avatar">눈썹</label>
          <div class="item-selection avatar-section" id="brows">
            <img src="{% static "character/brows/brows1.png" %}" alt="눈썹 1" data-id="1" class="selected">
            <img src="{% static "character/brows/brows2.png" %}" alt="눈썹 2" data-id="2">
          </div>
        </div>
        <div>
          <label for="avatar">눈</label>
          <div class="item-selection avatar-section" id="eyes">
            <img src="{% static "character/eyes/eyes1.png" %}" alt="눈 1" data-id="1" class="selected">
            <img src="{% static "character/eyes/eyes2.png" %}" alt="눈 2" data-id="2">
          </div>
        </div>
        <div>
          <label for="avatar">코</label>
          <div class="item-selection avatar-section" id="nose">
            <img src="{% static "character/nose/nose1.png" %}" alt="코 1" data-id="1" class="selected">
            <img src="{% static "character/nose/nose2.png" %}" alt="코 2" data-id="2">
          </div>
        </div>
        <div>
          <label for="avatar">입</label>
          <div class="item-selection avatar-section" id="mouth">
            <img src="{% static "character/mouth/mouth1.png" %}" alt="입 1" data-id="1" class="selected">
            <img src="{% static "character/mouth/mouth2.png" %}" alt="입 2" data-id="2">
            <img src="{% static "character/mouth/mouth3.png" %}" alt="입 2" data-id="3">
          </div>
        </div>
        <div>
          <label for="avatar">메이크업</label>
          <div class="item-selection avatar-section-optional" id="makeup">
            <img src="{% static "character/makeup/makeup1.png" %}" alt="메이크업 1" data-id="1">
            <img src="{% static "character/makeup/makeup2.png" %}" alt="메이크업 2" data-id="2">
            <img src="{% static "character/makeup/makeup3.png" %}" alt="메이크업 2" data-id="3">
          </div>
        </div>
      </div>
      <div class="fashion-container">
        <div>
          <label for="avatar">옷</label>
          <div class="item-selection avatar-section" id="clothes">
            <img src="{% static "character/clothes/clothes1.png" %}" alt="옷 1" data-id="1" class="selected">
            <img src="{% static "character/clothes/clothes2.png" %}" alt="옷 2" data-id="2">
            <img src="{% static "character/clothes/clothes3.png" %}" alt="옷 2" data-id="3">
          </div>
        </div>
        <div>
          <label for="avatar">귀걸이</label>
          <div class="item-selection avatar-section-optional" id="acc">
            <img src="{% static "character/acc/acc1.png" %}" alt="귀걸이 1" data-id="1">
            <img src="{% static "character/acc/acc2.png" %}" alt="귀걸이 2" data-id="2">
          </div>
        </div>
      </div>
    </div>
  </div>

  <form method='post'>
    {% csrf_token %}
    <fieldset>
      <legend>아바타</legend>
        <div>
          <input type="text" id="avatar" name="avatar">
          <label for="scales">avatar</label>
        </div>
    </fieldset>
    {% comment %} <a href="{% url 'main:home'%}">프로필 설정 완료 !</a> {% endcomment %}
    <button class="avatar" type="submit">다음</button>
  </form>
{% endblock %}

{% block scripts%}

<script>
  const options = document.querySelectorAll('.options-select div');
  const containers = document.querySelectorAll('.options-container > div');

  options.forEach((option, index) => {
    option.addEventListener('click', () => {
      // 이미 선택된 경우 선택 해제
      if (option.classList.contains('option-selected')) {
        option.classList.remove('option-selected');
        containers[index].style.display = 'none';
      } else {
        // 다른 선택 해제
        options.forEach((otherOption) => {
          otherOption.classList.remove('option-selected');
        });

        // 선택한 요소 표시
        option.classList.add('option-selected');

        // 선택한 옵션에 해당하는 container를 보임
        containers.forEach((container) => {
          container.style.display = 'none';
        });
        containers[index].style.display = 'block';
      }
    });
  });

  const avatarSections = document.querySelectorAll('.avatar-section');
  avatarSections.forEach(section => {
    const imagesInCategory = section.querySelectorAll('img');
    imagesInCategory.forEach(image => {
      image.addEventListener('click', () => {
        const currentSelected = section.querySelector('.selected');
        if (currentSelected) {
          currentSelected.classList.remove('selected');
        }
        image.classList.add('selected');

        // 이미지의 id 가져오기
        const divId = image.closest('div').id;
        const dataId = image.dataset.id;
        // id와 동일한 이름의 클래스를 가진 div 요소 찾기
        const divElement = document.querySelector(`.${divId}`);

        // 원하는 이미지 경로로 배경 이미지 변경
        divElement.style.backgroundImage = `url("{% static 'character/' %}${divId}/${divId}${dataId}.png")`;
      });
    });
  });

  const avatarSectionsOptional = document.querySelectorAll('.avatar-section-optional');
  avatarSectionsOptional.forEach(section => {
    const images = section.querySelectorAll('img');
  
    images.forEach(image => {
      image.addEventListener('click', () => {
        const isSelected = image.classList.contains('selected');
  
        // 이미 선택된 이미지인 경우 선택 해제
        if (isSelected) {
          image.classList.remove('selected');
          const divId = image.closest('div').id;
          // id와 동일한 이름의 클래스를 가진 div 요소 찾기
          const divElement = document.querySelector(`.${divId}`);

          // 원하는 이미지 경로로 배경 이미지 변경
          divElement.style.backgroundImage = `none`;
        } 
        else {
          const selectedImage = section.querySelector('.selected');
  
          // 다른 이미지가 선택되어 있는 경우 선택 해제하고 현재 이미지 선택
          if (selectedImage) {
            selectedImage.classList.remove('selected');
          }
  
          // 현재 이미지 선택
          image.classList.add('selected');
          const divId = image.closest('div').id;
          const dataId = image.dataset.id;
          const divElement = document.querySelector(`.${divId}`);

          // 원하는 이미지 경로로 배경 이미지 변경
          divElement.style.backgroundImage = `url("{% static 'character/' %}${divId}/${divId}${dataId}.png")`;
        }
      });
    });
  });

  //첫 프로필 화면 로드
  window.addEventListener('DOMContentLoaded', () => {
    const avatarSections = document.querySelectorAll('.avatar-section');
    avatarSections.forEach(section => {
      const selectedImages = section.querySelectorAll('img.selected');
      selectedImages.forEach(image => {
        const divId = image.closest('div').id;
        const dataId = image.dataset.id;
        const divElement = document.querySelector(`.${divId}`);

        // 원하는 이미지 경로로 배경 이미지 변경
        divElement.style.backgroundImage = `url("{% static 'character/' %}${divId}/${divId}${dataId}.png")`;
      });
    });
  });


  // 폼 전송 시 선택된 이미지 정보를 문자열로 변환하여 전송
  const avatarItemSelection = document.querySelectorAll('.item-selection');
  const form = document.querySelector('form');
  form.addEventListener('submit', () => {
    let selectedImages = '';
    const categoryOrder = [1, 0, 1, 1, 1, 1, 0, 1, 0]; // 앞머리, 뒷머리, 눈썹, 눈, 코, 입, 메이크업, 옷, 악세서리
    categoryOrder.forEach((category, index) => {
      const imagesInCategory = avatarItemSelection[index].querySelectorAll('img');
      const selectedImage = avatarItemSelection[index].querySelector('.selected');
      const selectedIndex = selectedImage ? Array.from(imagesInCategory).indexOf(selectedImage) + 1 : 0;
      selectedImages += selectedIndex.toString();
    });
    document.getElementById('avatar').value = selectedImages;
    console.log(selectedImages);
  });

  
</script>
{% endblock %}

